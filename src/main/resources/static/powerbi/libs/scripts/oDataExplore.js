"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),powerbi;!function(t){var e;!function(e){var r;!function(e){function r(t){return new s(t||{})}function n(t){var e=new l(t),r=e.getType(),n=g[r];if(n===g.property)return new y(t);if(n===g.literal)return new m(t);var o=u[r];if(void 0!==o)return new f(t);var i=h[r];return void 0!==i?new d(t):void p.throwException(x.invalidODataFilterNodeType(r))}var o=t.data.SemanticFilter,i=t.data.SQExprBuilder,a=jsCommon.Trace,p=jsCommon.Utility;e.createODataFilterParser=r;var u,s=function(){function t(t){this.predicateDepth=0;var e=10;this.maxPredicatesCount=t.maxPredicatesCount||e,this.supportMultiplePredicates=t.supportMultiplePredicates,this.supportNumericalPredicates=t.supportNumericalPredicates}return t.prototype.tryGetFilters=function(t){try{return this.getFilters(t)}catch(t){return x.traceError(t),null}},t.prototype.getFilters=function(t){t||p.throwException(x.odataFilterParserInputIsNullOrEmpty());var e=decodeURIComponent(t),r=n(ODataFilterGrammarParser.parse(e));this.predicateDepth=0;var o=this.filterNodeToSemanticFilters(r);return _.map(o,function(t){return{name:null,filter:t}})},t.prototype.filterNodeToSemanticFilters=function(t){if(this.predicateDepth++,this.predicateDepth>this.maxPredicatesCount&&p.throwException(x.multipleExpressionsExceededLimit(this.maxPredicatesCount)),t instanceof d){var e=t,r=this.buildSemanticFilter(e.getFilterOperator(),e.getProperty(),e.getConstant());return this.predicateDepth--,[r]}if(t instanceof f){this.supportMultiplePredicates||p.throwException(x.multipleExpressionsAreNotSupported(t.getType()));var n=this.filterTreeToSemanticFilters(t);return this.predicateDepth--,n}p.throwException(x.unexpectedRootODataFilterNode(t.getType()))},t.prototype.filterTreeToSemanticFilters=function(t){var e=t.getExpressionOperator();if(e===u.and){var r=this.filterNodeToSemanticFilters(t.getLeft()),n=this.filterNodeToSemanticFilters(t.getRight());return r.concat(n)}p.throwException(x.multipleExpressionsAreNotSupported(t.getType()))},t.prototype.buildSemanticFilter=function(t,e,r){var n=i.fieldExpr({column:{schema:void 0,entity:e.getEntity(),name:e.getColumn()}}),a=this.buildSQConstantExpr(r.getValue()),p=i.compare(this.convertToQueryOperator(t),n,a);return o.fromSQExpr(p)},t.prototype.buildSQConstantExpr=function(t){return this.supportNumericalPredicates&&_.isNumber(t)?i.double(t):_.isString(t)?i.text(t):void p.throwException(x.invalidDataTypeForConstantExpression(t,this.supportNumericalPredicates))},t.prototype.convertToQueryOperator=function(t){switch(t){case h.eq:return 0;case h.ne:case h.ge:case h.gt:case h.le:case h.lt:case h.add:case h.sub:case h.mul:case h.div:case h.mod:p.throwException(x.notSupportedODataOperator(t));break;default:p.throwException(x.unableToConvertToQueryOperator(t))}},t}(),l=function(){function t(t){this.dictionary=t}return t.prototype.getType=function(){var e=this.dictionary[t.NodeType];return null!=e?e.toLowerCase():null},t.NodeType="type",t}(),c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getLeft=function(){return this.getNode(e.Left)},e.prototype.getRight=function(){return this.getNode(e.Right)},e.prototype.getNode=function(t){var e=this.dictionary[t];return n(e)},e.Left="left",e.Right="right",e}(l),d=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getProperty=function(){return this.getLeft()},e.prototype.getFilterOperator=function(){return h[this.getType()]},e.prototype.getConstant=function(){return this.getRight()},e}(c),f=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getExpressionOperator=function(){return u[this.getType()]},e}(c),y=function(t){function e(e){var r=t.call(this,e)||this;return r.propertyDict={},r.init(),r}return __extends(e,t),e.prototype.init=function(){var t=this.dictionary[e.Name],r=t.split("/");r&&2===r.length||p.throwException(x.propertyMustContainEntityAndColumnName(t)),this.propertyDict[e.Column]=r[1],this.propertyDict[e.Entity]=r[0]},e.prototype.getEntity=function(){return this.propertyDict[e.Entity]},e.prototype.getColumn=function(){return this.propertyDict[e.Column]},e.Name="name",e.Column="column",e.Entity="entity",e}(l),m=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getValue=function(){return this.dictionary[e.Value]},e.Value="value",e}(l);!function(t){t[t.and=0]="and",t[t.or=1]="or"}(u||(u={}));var h;!function(t){t[t.eq=0]="eq",t[t.ne=1]="ne",t[t.lt=2]="lt",t[t.le=3]="le",t[t.gt=4]="gt",t[t.ge=5]="ge",t[t.add=6]="add",t[t.sub=7]="sub",t[t.mul=8]="mul",t[t.div=9]="div",t[t.mod=10]="mod"}(h||(h={}));var g;!function(t){t[t.property=0]="property",t[t.literal=1]="literal"}(g||(g={}));var x=function(){function t(){}return t.traceError=function(t){a.error("Throwing exception: "+JSON.stringify(t),null==t.Stack)},t.notSupportedODataOperator=function(t){return{name:"NotSupportedODataOperator",message:"The OData operator '"+t+"' is not supported."}},t.unableToConvertToQueryOperator=function(t){return{name:"UnableToConvertToQueryOperator",message:"Unable to convert the OData filter operator to a Query operator: "+t}},t.notSupportedQueryOperator=function(t){return{name:"NotSupportedQueryOperator",message:"The query operator '"+t+"' is not supported."}},t.invalidDataTypeForConstantExpression=function(t,e){return{name:"InvalidDataTypeForConstantExpression",message:"The data type of the value '"+t+"' is not supported. Only strings"+(e?" and numbers ":" ")+"are supported."}},t.propertyMustContainEntityAndColumnName=function(t){return{name:"PropertyMustContainEntityAndColumnName",message:"The property '"+t+"' must contain the entity name and the column name with the format 'EntityName/ColumnName'."}},t.multipleExpressionsAreNotSupported=function(t){return{name:"MultipleExpressionsAreNotSupported",message:"Multiple expressions are not allowed in additional Odata filters. The operator is invalid: "+t}},t.multipleExpressionsExceededLimit=function(t){return{name:"MultipleExpressionsExceededLimit",message:"Multiple expressions in additional Odata filters exceeded the limit: "+t}},t.invalidODataFilterNodeType=function(t){return{name:"InvalidODataFilterNodeType",message:"Invalid OData filter node type: "+t}},t.unexpectedRootODataFilterNode=function(t){return{name:"UnexpectedRootODataFilterNode",message:"Invalid OData filter node type at the root: "+t}},t.odataFilterParserInputIsNullOrEmpty=function(){return{name:"OdataFilterParserInputIsNullOrEmpty",message:"The input for the OData filter parser can not be null or empty."}},t}()}(r=e.odata||(e.odata={}))}(e=t.explore||(t.explore={}))}(powerbi||(powerbi={}));